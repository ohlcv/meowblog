{% extends 'core/base.html' %}
{% load blog_extras %}

{% block title %}{% if post %}ç¼–è¾‘æ–‡ç« {% elif category %}åœ¨ {{ category.name }} åˆ†ç±»ä¸‹åˆ›å»ºæ–‡ç« {% else %}å‘å¸ƒæ–°æ–‡ç« {% endif %} - Meow Blog{% endblock %}

{% block content %}
    <div class="fade-in-up page-container">
        <div class="page-header">
            <div class="page-header-content">
                <div class="page-header-title">
                    <h1 class="page-title">
                        {% if post %}
                            âœï¸ ç¼–è¾‘æ–‡ç« 
                        {% elif category %}
                            âœï¸ åœ¨ "{{ category.name }}" åˆ†ç±»ä¸‹åˆ›å»ºæ–‡ç« 
                        {% else %}
                            âœï¸ å‘å¸ƒæ–°æ–‡ç« 
                        {% endif %}
                    </h1>
                </div>
                <div class="page-header-actions">
                    <a href="{% if post %}{% get_post_url post %}{% elif category %}{% url 'accounts:category_posts' category_id=category.id %}{% else %}{% url 'blog:post_list' %}{% endif %}" class="btn-back">â† è¿”å›</a>
                </div>
            </div>
        </div>
        
        {# æ˜¾ç¤ºæ¶ˆæ¯ - ç”±å…¨å±€JavaScriptç³»ç»Ÿå¤„ç† #}
        {% if messages %}
            <div style="display: none;">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <div class="card">
            <form method="post" style="display: flex; flex-direction: column; gap: 1.5rem;">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
                    {{ form.title }}
                    {% if form.title.errors %}
                        <div class="error">{{ form.title.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.category.id_for_label }}" class="form-label">{{ form.category.label }}</label>
                    {{ form.category }}
                    {% if form.category.errors %}
                        <div class="error">{{ form.category.errors.0 }}</div>
                    {% endif %}
                    <small style="color: #6c757d; font-size: 0.9rem; margin-top: 0.5rem; display: block;">
                        é€‰æ‹©æ–‡ç« åˆ†ç±»ï¼Œå¦‚æœä¸é€‰æ‹©å°†å½’å…¥æœªåˆ†ç±»
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.visibility.id_for_label }}" class="form-label">{{ form.visibility.label }}</label>
                    {{ form.visibility }}
                    {% if form.visibility.errors %}
                        <div class="error">{{ form.visibility.errors.0 }}</div>
                    {% endif %}
                    <small style="color: #6c757d; font-size: 0.9rem; margin-top: 0.5rem; display: block;">
                        <strong>ğŸŒ å…¬å¼€ï¼š</strong>æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥çœ‹åˆ°<br>
                        <strong>ğŸ¤ äº’å…³ï¼š</strong>åªæœ‰äº’ç›¸å…³æ³¨çš„ç”¨æˆ·å¯ä»¥çœ‹åˆ°<br>
                        <strong>ğŸ”’ ç§å¯†ï¼š</strong>åªæœ‰ä½ è‡ªå·±å¯ä»¥çœ‹åˆ°
                    </small>
                </div>
                
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label for="{{ form.content.id_for_label }}" class="form-label">{{ form.content.label }}</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" id="preview-toggle" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                                ğŸ‘ï¸ é¢„è§ˆ
                            </button>
                            <button type="button" id="markdown-help" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                                â“ å¸®åŠ©
                            </button>
                        </div>
                    </div>
                    
                    <div id="editor-container" style="display: block;">
                        {{ form.content }}
                    </div>
                    
                    <div id="preview-container" style="display: none; background: white; border: 2px solid #e9ecef; border-radius: 0.5rem; padding: 1.5rem; min-height: 400px;">
                        <div id="markdown-preview" class="markdown-content"></div>
                    </div>
                    
                    {% if form.content.errors %}
                        <div class="error">{{ form.content.errors.0 }}</div>
                    {% endif %}
                    
                    <small style="color: #6c757d; font-size: 0.9rem; margin-top: 0.5rem; display: block;">
                        {{ form.content.help_text }}
                    </small>
                </div>
                
                
                <div style="display: flex; gap: 1rem; justify-content: center; padding-top: 1rem;">
                    <button type="submit" class="btn btn-primary" id="submit-btn" style="padding: 1rem 2rem; font-weight: 600;">
                        {% if post %}ğŸ’¾ ä¿å­˜ä¿®æ”¹{% else %}ğŸ“ å‘å¸ƒæ–‡ç« {% endif %}
                    </button>
                    <a href="{% if post %}{% get_post_url post %}{% elif category %}{% url 'accounts:category_posts' category_id=category.id %}{% else %}{% url 'blog:post_list' %}{% endif %}" class="btn btn-secondary" style="padding: 1rem 2rem;">âŒ å–æ¶ˆ</a>
                </div>
            </form>
        </div>
    </div>
    
    <style>
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        input[type="text"], select, textarea {
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        input[type="text"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 300px;
            line-height: 1.6;
        }
        
        .error {
            color: #dc3545;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem !important;
            }
            
            .card {
                padding: 1.5rem !important;
            }
            
            .fade-in-up > div:first-child {
                flex-direction: column !important;
                gap: 1rem !important;
            }
        }
    </style>
    
    <script>
        
        // Markdowné¢„è§ˆåŠŸèƒ½
        const previewToggle = document.getElementById('preview-toggle');
        const editorContainer = document.getElementById('editor-container');
        const previewContainer = document.getElementById('preview-container');
        const markdownPreview = document.getElementById('markdown-preview');
        const markdownHelp = document.getElementById('markdown-help');
        
        let isPreviewMode = false;
        
        // è¡¨å•æäº¤è°ƒè¯•
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            const submitBtn = document.getElementById('submit-btn');
            
            if (form && submitBtn) {
                // æ·»åŠ è¡¨å•æäº¤ç›‘å¬å™¨
                form.addEventListener('submit', function(e) {
                    console.log('è¡¨å•æäº¤äº‹ä»¶è§¦å‘');
                    
                    // æ£€æŸ¥å¿…å¡«å­—æ®µ
                    const title = document.querySelector('input[name="title"]').value.trim();
                    const content = document.querySelector('textarea[name="content"]').value.trim();
                    
                    if (!title) {
                        console.error('æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
                        e.preventDefault();
                        alert('æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
                        return;
                    }
                    
                    if (!content) {
                        console.error('å†…å®¹ä¸èƒ½ä¸ºç©º');
                        e.preventDefault();
                        alert('å†…å®¹ä¸èƒ½ä¸ºç©º');
                        return;
                    }
                    
                    console.log('è¡¨å•éªŒè¯é€šè¿‡ï¼Œæ­£åœ¨æäº¤...');
                    submitBtn.textContent = 'å‘å¸ƒä¸­...';
                    submitBtn.disabled = true;
                });
                
                // æ·»åŠ æŒ‰é’®ç‚¹å‡»ç›‘å¬å™¨
                submitBtn.addEventListener('click', function(e) {
                    console.log('æäº¤æŒ‰é’®è¢«ç‚¹å‡»');
                });
            }
        });
        
        // é¢„è§ˆåˆ‡æ¢åŠŸèƒ½
        if (previewToggle && editorContainer && previewContainer && markdownPreview) {
            previewToggle.addEventListener('click', function() {
                isPreviewMode = !isPreviewMode;
                
                if (isPreviewMode) {
                    // åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼
                    editorContainer.style.display = 'none';
                    previewContainer.style.display = 'block';
                    previewToggle.textContent = 'âœï¸ ç¼–è¾‘';
                    updatePreview();
                } else {
                    // åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
                    editorContainer.style.display = 'block';
                    previewContainer.style.display = 'none';
                    previewToggle.textContent = 'ğŸ‘ï¸ é¢„è§ˆ';
                }
            });
            
            // å®æ—¶æ›´æ–°é¢„è§ˆ
            if (contentTextarea) {
                contentTextarea.addEventListener('input', function() {
                    if (isPreviewMode) {
                        updatePreview();
                    }
                });
            }
        }
        
        // æ›´æ–°é¢„è§ˆå†…å®¹
        function updatePreview() {
            if (contentTextarea && markdownPreview) {
                const markdownText = contentTextarea.value;
                if (markdownText.trim()) {
                    // ç®€å•çš„Markdownæ¸²æŸ“
                    let html = markdownText
                        // æ ‡é¢˜
                        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                        // ç²—ä½“å’Œæ–œä½“
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        // ä»£ç å—
                        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                        .replace(/`(.*?)`/g, '<code>$1</code>')
                        // é“¾æ¥
                        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
                        // å›¾ç‰‡
                        .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" style="max-width: 100%; height: auto;">')
                        // åˆ—è¡¨
                        .replace(/^\* (.*$)/gim, '<li>$1</li>')
                        .replace(/^- (.*$)/gim, '<li>$1</li>')
                        .replace(/^(\d+)\. (.*$)/gim, '<li>$2</li>')
                        // å¼•ç”¨
                        .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
                        // åˆ†å‰²çº¿
                        .replace(/^---$/gim, '<hr>')
                        .replace(/^\*\*\*$/gim, '<hr>')
                        // æ¢è¡Œ
                        .replace(/\n/g, '<br>');
                    
                    // å¤„ç†åˆ—è¡¨
                    html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
                    
                    markdownPreview.innerHTML = html;
                } else {
                    markdownPreview.innerHTML = '<p style="color: #6c757d; font-style: italic;">æš‚æ— å†…å®¹é¢„è§ˆ</p>';
                }
            }
        }
        
        // Markdownå¸®åŠ©åŠŸèƒ½
        if (markdownHelp) {
            markdownHelp.addEventListener('click', function() {
                const helpContent = `
# Markdownè¯­æ³•å¸®åŠ©

## æ ‡é¢˜
\`\`\`
# ä¸€çº§æ ‡é¢˜
## äºŒçº§æ ‡é¢˜
### ä¸‰çº§æ ‡é¢˜
\`\`\`

## æ–‡æœ¬æ ¼å¼
\`\`\`
**ç²—ä½“æ–‡æœ¬**
*æ–œä½“æ–‡æœ¬*
\`è¡Œå†…ä»£ç \`
\`\`\`

## ä»£ç å—
\`\`\`
\`\`\`python
def hello():
    print("Hello, World!")
\`\`\`
\`\`\`

## é“¾æ¥å’Œå›¾ç‰‡
\`\`\`
[é“¾æ¥æ–‡æœ¬](https://example.com)
![å›¾ç‰‡æè¿°](å›¾ç‰‡URL)
\`\`\`

## åˆ—è¡¨
\`\`\`
- æ— åºåˆ—è¡¨é¡¹1
- æ— åºåˆ—è¡¨é¡¹2

1. æœ‰åºåˆ—è¡¨é¡¹1
2. æœ‰åºåˆ—è¡¨é¡¹2
\`\`\`

## å¼•ç”¨
\`\`\`
> è¿™æ˜¯å¼•ç”¨å†…å®¹
\`\`\`

## è¡¨æ ¼
\`\`\`
| åˆ—1 | åˆ—2 | åˆ—3 |
|-----|-----|-----|
| å†…å®¹1 | å†…å®¹2 | å†…å®¹3 |
\`\`\`

## åˆ†å‰²çº¿
\`\`\`
---
\`\`\`
                `;
                
                // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºå¸®åŠ©å†…å®¹
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 2rem;
                    border-radius: 1rem;
                    max-width: 600px;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                `;
                
                modalContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 style="margin: 0; color: #2c3e50;">Markdownè¯­æ³•å¸®åŠ©</h2>
                        <button id="close-help" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;">&times;</button>
                    </div>
                    <div class="markdown-content">${helpContent.replace(/\n/g, '<br>').replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/`(.*?)`/g, '<code>$1</code>')}</div>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // å…³é—­æ¨¡æ€æ¡†
                const closeHelp = document.getElementById('close-help');
                closeHelp.addEventListener('click', function() {
                    document.body.removeChild(modal);
                });
                
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
            });
        }
    </script>
{% endblock %}