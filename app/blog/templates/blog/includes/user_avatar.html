{% comment %}
用户头像链接组件（集成关注功能）
参数：
- user: 用户对象
- size: 头像大小 ('small'|'medium'|'large') (默认: 'medium')
- show_name: 是否显示用户名 (默认: true)
- link_to_profile: 是否链接到用户资料页 (默认: true)
- show_follow_button: 是否显示关注按钮 (默认: true)
- is_following: 是否已关注该用户 (默认: false)
- current_user: 当前登录用户 (可选)
- is_navbar: 是否为导航栏头像 (默认: false) - 导航栏头像不显示关注按钮和用户名
- style: 自定义样式类 (可选)
{% endcomment %}

{% load static %}

<div class="user-avatar-container user-avatar-{{ size|default:'medium' }}{% if is_navbar %} user-avatar-navbar{% endif %}" 
     data-user-id="{{ user.id }}" 
     data-avatar-instance="{{ user.id }}_{{ forloop.counter0|default:0 }}">
    {# 头像部分 #}
    {% if link_to_profile != False %}
        {# 根据用户身份跳转到不同的个人中心URL #}
        {% if current_user and current_user.id == user.id %}
            {# 自己的头像跳转到自己的个人中心 #}
            <a href="{% url 'accounts:profile_center' %}" 
               class="user-avatar-link">
                <span class="user-avatar-circle">
                    {{ user.username|first|upper }}
                </span>
                <span class="user-avatar-name">{{ user.profile.displayname|default:user.username }}</span>
            </a>
        {% else %}
            {# 别人的头像跳转到该用户的个人中心 #}
            <a href="{% url 'accounts:user_profile' user_id=user.id %}" 
               class="user-avatar-link">
                <span class="user-avatar-circle">
                    {{ user.username|first|upper }}
                </span>
                <span class="user-avatar-name">{{ user.profile.displayname|default:user.username }}</span>
            </a>
        {% endif %}
    {% else %}
        <div class="user-avatar-static">
            <span class="user-avatar-circle">
                {{ user.username|first|upper }}
            </span>
            <span class="user-avatar-name">{{ user.username }}</span>
        </div>
    {% endif %}

    {# 关注按钮部分 - 导航栏不显示关注按钮 #}
    {% if not is_navbar and current_user and current_user.is_authenticated and current_user.id != user.id %}
        <button class="follow-btn {% if is_following %}following{% endif %}" 
                data-user-id="{{ user.id }}"
                data-avatar-instance="{{ user.id }}_{{ forloop.counter0|default:0 }}"
                data-following="{{ is_following|yesno:'true,false' }}"
                onclick="event.stopPropagation();">
            <span class="follow-icon">{% if is_following %}☰ 已关注{% else %}+ 关注{% endif %}</span>
        </button>
    {% elif not is_navbar %}
        <div style="height: 24px;"></div>
    {% endif %}
        </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 设置头像尺寸
    const avatarCircles = document.querySelectorAll('.user-avatar-circle');
    const avatarNames = document.querySelectorAll('.user-avatar-name');
    const avatarContainers = document.querySelectorAll('.user-avatar-container');
    
    avatarContainers.forEach(function(container) {
        const size = '{{ size|default:"medium" }}';
        const circle = container.querySelector('.user-avatar-circle');
        const name = container.querySelector('.user-avatar-name');
        const link = container.querySelector('.user-avatar-link');
        const static = container.querySelector('.user-avatar-static');
        
        if (size === 'small') {
            // 小尺寸：紧凑布局
            if (circle) {
                circle.style.width = '32px';
                circle.style.height = '32px';
                circle.style.fontSize = '1rem';
            }
            if (name) {
                name.style.fontSize = '0.8rem';
            }
            if (link) {
                link.style.padding = '0.25rem 0.5rem';
                link.style.gap = '0.5rem';
            }
            if (static) {
                static.style.padding = '0.25rem 0.5rem';
                static.style.gap = '0.5rem';
            }
        } else if (size === 'large') {
            // 大尺寸：宽松布局
            if (circle) {
                circle.style.width = '56px';
                circle.style.height = '56px';
                circle.style.fontSize = '1.6rem';
            }
            if (name) {
                name.style.fontSize = '1.1rem';
            }
            if (link) {
                link.style.padding = '0.75rem 1.25rem';
                link.style.gap = '1rem';
            }
            if (static) {
                static.style.padding = '0.75rem 1.25rem';
                static.style.gap = '1rem';
            }
        } else {
            // 中等尺寸：默认布局
            if (circle) {
                circle.style.width = '44px';
                circle.style.height = '44px';
                circle.style.fontSize = '1.3rem';
            }
            if (name) {
                name.style.fontSize = '0.95rem';
            }
            if (link) {
                link.style.padding = '0.5rem 1rem';
                link.style.gap = '0.75rem';
            }
            if (static) {
                static.style.padding = '0.5rem 1rem';
                static.style.gap = '0.75rem';
            }
        }
    });
    
    // 响应式设计 - 手机版优化
    function adjustForMobile() {
        const isMobile = window.innerWidth <= 768;
        const avatarContainers = document.querySelectorAll('.user-avatar-container');
        
        avatarContainers.forEach(function(container) {
            const circle = container.querySelector('.user-avatar-circle');
            const name = container.querySelector('.user-avatar-name');
            const followBtn = container.querySelector('.follow-btn');
            
            if (isMobile) {
                // 手机版：更紧凑的布局
                if (circle) {
                    circle.style.width = '28px';
                    circle.style.height = '28px';
                    circle.style.fontSize = '0.9rem';
                }
                if (name) {
                    name.style.fontSize = '0.75rem';
                    name.style.maxWidth = '60px';
                    name.style.overflow = 'hidden';
                    name.style.textOverflow = 'ellipsis';
                    name.style.whiteSpace = 'nowrap';
                }
                if (followBtn) {
                    followBtn.style.padding = '0.2rem 0.5rem';
                    followBtn.style.fontSize = '0.65rem';
                    followBtn.style.marginTop = '0.2rem';
                }
                // 调整容器尺寸
                container.style.minHeight = '60px';
                container.style.width = '60px';
            } else {
                // 桌面版：恢复默认尺寸
                const size = '{{ size|default:"medium" }}';
                if (size === 'small') {
                    if (circle) {
                        circle.style.width = '32px';
                        circle.style.height = '32px';
                        circle.style.fontSize = '1rem';
                    }
                    if (name) {
                        name.style.fontSize = '0.8rem';
                        name.style.maxWidth = 'none';
                        name.style.overflow = 'visible';
                        name.style.textOverflow = 'unset';
                        name.style.whiteSpace = 'normal';
                    }
                } else if (size === 'large') {
                    if (circle) {
                        circle.style.width = '56px';
                        circle.style.height = '56px';
                        circle.style.fontSize = '1.6rem';
                    }
                    if (name) {
                        name.style.fontSize = '1.1rem';
                        name.style.maxWidth = 'none';
                        name.style.overflow = 'visible';
                        name.style.textOverflow = 'unset';
                        name.style.whiteSpace = 'normal';
                    }
                } else {
                    if (circle) {
                        circle.style.width = '44px';
                        circle.style.height = '44px';
                        circle.style.fontSize = '1.3rem';
                    }
                    if (name) {
                        name.style.fontSize = '0.95rem';
                        name.style.maxWidth = 'none';
                        name.style.overflow = 'visible';
                        name.style.textOverflow = 'unset';
                        name.style.whiteSpace = 'normal';
                    }
                }
                if (followBtn) {
                    followBtn.style.padding = '0.25rem 0.75rem';
                    followBtn.style.fontSize = '0.7rem';
                    followBtn.style.marginTop = '0.25rem';
                }
                container.style.minHeight = '80px';
                container.style.width = '80px';
            }
        });
    }
    
    // 初始调整
    adjustForMobile();
    
    // 监听窗口大小变化
    window.addEventListener('resize', adjustForMobile);
    
    // 设置关注按钮样式 - 修复多个相同用户头像的问题
    const avatarInstance = '{{ user.id }}_{{ forloop.counter0|default:0 }}';
    const followBtn = document.querySelector(`.follow-btn[data-avatar-instance="${avatarInstance}"]`);
    if (followBtn) {
        const isFollowing = followBtn.dataset.following === 'true';
        
        // 使用CSS类而不是内联样式
        if (isFollowing) {
            followBtn.classList.add('following');
            followBtn.classList.remove('not-following');
        } else {
            followBtn.classList.add('not-following');
            followBtn.classList.remove('following');
        }
        
        // 关注功能 - 防止重复绑定事件监听器
        // 检查是否已经绑定过事件监听器
        if (followBtn.dataset.listenerAttached === 'true') {
            return; // 已经绑定过，直接返回
        }
        
        // 标记已绑定
        followBtn.dataset.listenerAttached = 'true';
        
        // 定义事件处理函数
        function handleFollowClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            
            // 检查用户是否已登录
            const isAuthenticated = '{{ current_user.is_authenticated|yesno:"true,false" }}' === 'true';
            if (!isAuthenticated) {
                alert('请先登录后再进行关注操作');
                return;
            }
            
            const userId = this.dataset.userId;
            const isFollowing = this.dataset.following === 'true';
            
            // 获取CSRF token - 改进获取方式
            let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            if (!csrfToken) {
                csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
            }
            if (!csrfToken) {
                csrfToken = '{{ csrf_token }}';
            }
            
            // 检查CSRF token是否获取成功
            if (!csrfToken || csrfToken === 'None') {
                alert('安全验证失败，请刷新页面后重试');
                return;
            }
            
            // 根据当前状态选择操作
            const action = isFollowing ? 'unfollow' : 'follow';
            const url = `/blog/user/${userId}/${action}/`;
            
            
            // 显示加载状态
            const originalText = this.querySelector('.follow-icon').textContent;
            this.querySelector('.follow-icon').textContent = '⏳ 处理中...';
            this.disabled = true;
            
            // 发送AJAX请求
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // 更新按钮状态
                    updateFollowButton(this, data.is_following);
                    
                    // 显示成功消息
                    if (data.message) {
                        showMessage(data.message, 'success');
                    }
                } else {
                    // 显示错误消息
                    showMessage(data.message || '操作失败，请重试', 'error');
                }
            })
            .catch(error => {
                console.error('关注操作失败:', error);
                let errorMessage = '操作失败，请重试';
                
                if (error.message.includes('HTTP error')) {
                    errorMessage = '服务器错误，请稍后重试';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = '网络连接失败，请检查网络连接';
                }
                
                showMessage(errorMessage, 'error');
            })
            .finally(() => {
                // 恢复按钮状态
                this.disabled = false;
            });
        }
        
        // 绑定事件监听器
        followBtn.addEventListener('click', handleFollowClick);
        
        // 更新关注按钮状态的函数 - 支持同步多个相同用户的头像
        function updateFollowButton(button, isFollowing) {
            const userId = button.dataset.userId;
            const icon = button.querySelector('.follow-icon');
            
            // 更新当前按钮
            updateSingleButton(button, icon, isFollowing);
            
            // 同步更新所有相同用户的头像按钮
            const allSameUserButtons = document.querySelectorAll(`.follow-btn[data-user-id="${userId}"]`);
            allSameUserButtons.forEach(btn => {
                if (btn !== button) { // 避免重复更新当前按钮
                    const btnIcon = btn.querySelector('.follow-icon');
                    updateSingleButton(btn, btnIcon, isFollowing);
                }
            });
        }
        
        // 更新单个按钮状态的辅助函数
        function updateSingleButton(button, icon, isFollowing) {
            if (isFollowing) {
                // 已关注状态
                icon.textContent = '✓ 已关注';
                button.classList.add('following');
                button.classList.remove('not-following');
            } else {
                // 未关注状态
                icon.textContent = '+ 关注';
                button.classList.add('not-following');
                button.classList.remove('following');
            }
            
            button.dataset.following = isFollowing;
        }
        
        // 显示消息的函数
        function showMessage(message, type = 'info') {
            // 创建消息元素
            const messageDiv = document.createElement('div');
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 9999;
                max-width: 300px;
                word-wrap: break-word;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transition: all 0.3s ease;
            `;
            
            // 根据类型设置样式
            if (type === 'success') {
                messageDiv.style.backgroundColor = '#28a745';
            } else if (type === 'error') {
                messageDiv.style.backgroundColor = '#dc3545';
            } else {
                messageDiv.style.backgroundColor = '#17a2b8';
            }
            
            // 添加到页面
            document.body.appendChild(messageDiv);
            
            // 3秒后自动移除
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }
    }
});
</script>